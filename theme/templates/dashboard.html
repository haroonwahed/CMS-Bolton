{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="flex h-screen" style="background: var(--bg);">
    <!-- Left Sidebar -->
    <div class="w-80 card border-r flex flex-col" style="border-radius: 0; border-right: 1px solid var(--border);">
        <!-- Dashboard Title -->
        <div class="p-6" style="border-bottom: 1px solid var(--border);">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Dashboard</h2>
                <a href="{% url 'contracts:workflow_create' %}" class="btn-primary text-sm flex items-center space-x-1" style="height: 32px; padding: 0 12px;">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span>Start Workflow</span>
                </a>
            </div>
        </div>

        <!-- Views Section -->
        <div class="p-6" style="border-bottom: 1px solid var(--border);">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-900">Views</h3>
                <div class="flex items-center space-x-2">
                    <button onclick="addNewView()" style="color: var(--muted);" class="p-1 hover:text-primary-600 focus-ring rounded-xl" title="Add view">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </button>
                    <button onclick="collapseViews()" id="views-toggle" style="color: var(--muted);" class="p-1 hover:text-primary-600 focus-ring rounded-xl" title="Collapse views">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="space-y-1">
                <div class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                        <span>Starred contracts</span>
                    </div>
                    <span class="text-xs text-gray-500">0</span>
                </div>
                <a href="{% url 'contracts:contract_list' %}" class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>All</span>
                    </div>
                    <span class="text-xs text-gray-500">{{ total_contracts }}</span>
                </a>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="p-6" style="border-bottom: 1px solid var(--border);">
            <h3 class="text-sm font-medium text-gray-900 mb-4">Quick Stats</h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Total Contracts</span>
                    <span class="font-semibold text-primary-700">{{ total_contracts }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Active Workflows</span>
                    <span class="font-semibold text-accent-500">{{ active_workflows }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Pending Tasks</span>
                    <span class="font-semibold text-orange-600">{{ pending_tasks }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Trademark Requests</span>
                    <span class="font-semibold text-green-600">{{ trademark_requests }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">High Risk Items</span>
                    <span class="font-semibold text-red-600">{{ top_risks|length }}</span>
                </div>
            </div>
        </div>

        <!-- Repository Section -->
        <div class="p-6" style="border-bottom: 1px solid var(--border);">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-900">Contract Pipeline</h3>
                <button onclick="collapseRepository()" id="repository-toggle" style="color: var(--muted);" class="p-1 hover:text-primary-600 focus-ring rounded-xl" title="Collapse repository">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-1" id="repository-list">
                {% for stage, count in pipeline_data %}
                <a href="{% url 'contracts:contract_list' %}?status={{ stage }}" class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>{{ stage }}</span>
                    </div>
                    <span class="text-xs text-gray-500">{{ count }}</span>
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-900">Quick Actions</h3>
                <button onclick="collapseWorkflows()" id="workflows-toggle" style="color: var(--muted);" class="p-1 hover:text-primary-600 focus-ring rounded-xl" title="Collapse actions">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-1" id="workflows-list">
                <a href="{% url 'contracts:workflow_dashboard' %}" class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span>Active Workflows</span>
                    </div>
                    <span class="text-xs text-gray-500">{{ active_workflows }}</span>
                </a>
                <a href="{% url 'contracts:legal_task_board' %}" class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <span>Legal Tasks</span>
                    </div>
                    <span class="text-xs text-gray-500">{{ pending_tasks }}</span>
                </a>
                <a href="{% url 'contracts:trademark_request_list' %}" class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Trademarks</span>
                    </div>
                    <span class="text-xs text-gray-500">{{ pending_trademarks }}</span>
                </a>
                <a href="{% url 'contracts:risk_log_list' %}" class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <span>Risk Management</span>
                    </div>
                    <span class="text-xs text-gray-500">{{ risk_count }}</span>
                </a>
                <a href="{% url 'contracts:due_diligence_list' %}" class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>Due Diligence</span>
                    </div>
                    <span class="text-xs text-gray-500">{{ dd_count|default:"0" }}</span>
                </a>
                <a href="{% url 'contracts:budget_list' %}" class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                        <span>Budgets</span>
                    </div>
                    <span class="text-xs text-gray-500">{{ budget_count|default:"0" }}</span>
                </a>
                <a href="{% url 'contracts:compliance_checklist_list' %}" class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Compliance</span>
                    </div>
                    <span class="text-xs text-gray-500">{{ upcoming_checklists|length }}</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col">
        <!-- Search and Filters Bar -->
        <div class="card px-6 py-3" style="border-radius: 0; border-bottom: 1px solid var(--border);">
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <div class="relative">
                        <input type="text" placeholder="Search contracts..." class="input-field w-full pl-10 pr-4 text-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-4 w-4" style="color: var(--muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <select class="chip chip-inactive text-sm">
                    <option>All Status</option>
                    <option>Draft</option>
                    <option>Internal Review</option>
                    <option>Negotiation</option>
                    <option>Signature</option>
                </select>
                <select class="chip chip-inactive text-sm">
                    <option>All Types</option>
                    <option>MSA</option>
                    <option>NDA</option>
                    <option>Order Form</option>
                    <option>Statement of Work</option>
                </select>
            </div>
        </div>

        <!-- Contract List -->
        <div class="flex-1 card" style="border-radius: 0;">
            <div class="px-6 py-3" style="border-bottom: 1px solid var(--border);">
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-xs font-medium uppercase tracking-wide" style="color: var(--muted);">Contract</div>
                    <div class="text-xs font-medium uppercase tracking-wide" style="color: var(--muted);">Current Status</div>
                </div>
            </div>

            <!-- Contract Rows -->
            <div style="border-color: var(--border);" class="divide-y">
                {% for contract in recent_contracts %}
                <a href="{% url 'contracts:contract_detail' contract.pk %}" class="block px-6 py-4 hover:bg-primary-500/3 transition-colors rounded-xl mx-2 my-1">
                    <div class="grid grid-cols-2 gap-4 items-center">
                        <div>
                            <div class="text-sm font-medium text-gray-900">{{ contract.title }}</div>
                            <div class="text-xs" style="color: var(--muted);">{{ contract.counterparty }}</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            {% if contract.status == 'DRAFT' %}
                                <span class="badge badge-draft">DRAFT</span>
                            {% elif contract.status == 'INTERNAL_REVIEW' %}
                                <span class="badge badge-unverified">REVIEW</span>
                            {% elif contract.status == 'NEGOTIATION' %}
                                <span class="badge badge-unverified">NEGOTIATION</span>
                            {% elif contract.status == 'SIGNATURE' %}
                                <span class="badge badge-unverified">SIGNATURE</span>
                            {% elif contract.status == 'EXECUTED' %}
                                <span class="badge badge-active">EXECUTED</span>
                            {% else %}
                                <span class="badge badge-active">ACTIVE</span>
                            {% endif %}
                            {% if contract.milestone_date %}
                                <span class="text-xs" style="color: var(--muted);">Due {{ contract.milestone_date|date:"M d" }}</span>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% empty %}
                <div class="px-6 py-8 text-center">
                    <div style="color: var(--muted);">No contracts found.</div>
                    <a href="{% url 'contracts:contract_create' %}" class="link text-sm font-medium">Create your first contract</a>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            <div class="border-t border-gray-200 bg-white px-6 py-3 flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    Showing {{ recent_contracts|length }} of {{ total_contracts }} contracts
                </div>
                <div class="flex items-center space-x-2">
                    <a href="{% url 'contracts:contract_list' %}" class="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 text-teal-600">View All</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function addNewView() {
    // Show modal for creating custom view
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Create Custom View</h3>
            <form id="custom-view-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">View Name</label>
                    <input type="text" id="view-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Enter view name..." required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                    <select id="view-status" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Statuses</option>
                        <option value="DRAFT">Draft</option>
                        <option value="INTERNAL_REVIEW">Internal Review</option>
                        <option value="NEGOTIATION">Negotiation</option>
                        <option value="SIGNATURE">Signature</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Type</label>
                    <select id="view-type" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Types</option>
                        <option value="MSA">MSA</option>
                        <option value="NDA">NDA</option>
                        <option value="ORDER_FORM">Order Form</option>
                        <option value="SOW">Statement of Work</option>
                    </select>
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700">Create View</button>
                    <button type="button" onclick="closeViewModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">Cancel</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);

    document.getElementById('custom-view-form').onsubmit = function(e) {
        e.preventDefault();
        const viewName = document.getElementById('view-name').value;
        const status = document.getElementById('view-status').value;
        const type = document.getElementById('view-type').value;

        // Create the view URL with filters
        let viewUrl = '{% url "contracts:contract_list" %}?';
        const params = [];
        if (status) params.push(`status=${status}`);
        if (type) params.push(`contract_type=${type}`);
        viewUrl += params.join('&');

        // Add to views list
        const viewsList = document.querySelector('.space-y-1');
        const newView = document.createElement('a');
        newView.href = viewUrl;
        newView.className = 'flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded';
        newView.innerHTML = `
            <div class="flex items-center">
                <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span>${viewName}</span>
            </div>
            <span class="text-xs text-gray-500">0</span>
        `;
        viewsList.appendChild(newView);

        closeViewModal();
    };
}

function closeViewModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) modal.remove();
}

function toggleWorkflowDropdown() {
    const dropdown = document.getElementById('workflow-dropdown');
    if (dropdown) {
        dropdown.classList.toggle('hidden');
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const workflowDropdown = document.getElementById('workflow-dropdown');
    if (workflowDropdown) {
        const workflowButton = event.target.closest('button[onclick="toggleWorkflowDropdown()"]');

        if (!workflowButton && !workflowDropdown.contains(event.target)) {
            workflowDropdown.classList.add('hidden');
        }
    }
});

function collapseViews() {
    const viewsList = document.querySelector('.space-y-1');
    const toggle = document.getElementById('views-toggle');

    if (viewsList && toggle) {
        const svg = toggle.querySelector('svg path');

        if (viewsList.style.display === 'none') {
            viewsList.style.display = 'block';
            if (svg) svg.setAttribute('d', 'M19 9l-7 7-7-7');
            toggle.title = 'Collapse views';
        } else {
            viewsList.style.display = 'none';
            if (svg) svg.setAttribute('d', 'M9 5l7 7-7 7');
            toggle.title = 'Expand views';
        }
    }
}

function collapseRepository() {
    const repositoryList = document.getElementById('repository-list');
    const toggle = document.getElementById('repository-toggle');

    if (repositoryList && toggle) {
        const svg = toggle.querySelector('svg path');

        if (repositoryList.style.display === 'none') {
            repositoryList.style.display = 'block';
            if (svg) svg.setAttribute('d', 'M19 9l-7 7-7-7');
            toggle.title = 'Collapse repository';
        } else {
            repositoryList.style.display = 'none';
            if (svg) svg.setAttribute('d', 'M9 5l7 7-7 7');
            toggle.title = 'Expand repository';
        }
    }
}

function collapseWorkflows() {
    const workflowsList = document.getElementById('workflows-list');
    const toggle = document.getElementById('workflows-toggle');

    if (workflowsList && toggle) {
        const svg = toggle.querySelector('svg path');

        if (workflowsList.style.display === 'none') {
            workflowsList.style.display = 'block';
            if (svg) svg.setAttribute('d', 'M19 9l-7 7-7-7');
            toggle.title = 'Collapse actions';
        } else {
            workflowsList.style.display = 'none';
            if (svg) svg.setAttribute('d', 'M9 5l7 7-7 7');
            toggle.title = 'Expand actions';
        }
    }
}
</script>
{% endblock %}
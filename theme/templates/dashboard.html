{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block page_title %}
Welcome, {{ request.user.first_name|default:request.user.username }}
{% endblock %}

{% block content %}
<!-- Contract Pipeline -->
<div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">Contract Pipeline</h2>
    <div class="w-full bg-gray-200 rounded-full h-2.5">
        <div class="bg-blue-600 h-2.5 rounded-full" style="width: 45%"></div> <!-- Example width -->
    </div>
    <div class="grid grid-cols-4 gap-4 mt-2 text-center">
        {% for stage, count in pipeline_data %}
            <div>
                <p class="text-sm text-gray-500">{{ stage }}</p>
                <p class="text-2xl font-bold text-gray-800">{{ count }}</p>
            </div>
        {% endfor %}
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Center Column: Alerts & Milestones -->
    <div class="lg:col-span-2 space-y-8">
        <!-- High-Risk Alerts -->
        <div class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">High-Risk Alerts</h3>
            <div class="space-y-4">
                {% for risk in top_risks %}
                    <div class="flex items-center justify-between p-3 rounded-md bg-red-50 border border-red-200">
                        <div>
                            <a href="{% url 'contracts:risk_log_update' risk.pk %}" class="font-semibold text-red-800 hover:underline">{{ risk.title }}</a>
                            <p class="text-sm text-gray-600">
                                Linked Contract:
                                {% if risk.linked_contract %}
                                    <a href="{% url 'contracts:contract_detail' risk.linked_contract.pk %}" class="text-blue-600">{{ risk.linked_contract.title }}</a>
                                {% else %}
                                    N/A
                                {% endif %}
                            </p>
                        </div>
                        <span class="px-2 py-1 text-xs font-semibold leading-tight text-red-700 bg-red-100 rounded-full">{{ risk.get_mitigation_status_display }}</span>
                    </div>
                {% empty %}
                    <p class="text-gray-500 italic">No high-risk items to display.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Right Column: Compliance Timeline -->
    <div class="lg:col-span-1 space-y-8">
        <div class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Compliance Timeline</h3>
            <div class="space-y-4">
                 {% for checklist in upcoming_checklists %}
                    <div class="border-l-4 pl-4 {% if checklist.due_date < today %}border-red-500{% else %}border-yellow-400{% endif %}">
                        <a href="{% url 'contracts:compliance_checklist_detail' checklist.pk %}" class="font-semibold text-blue-600 hover:underline">{{ checklist.name }}</a>
                        <p class="text-sm text-gray-500">Due: {{ checklist.due_date }}</p>
                    </div>
                {% empty %}
                    <p class="text-gray-500 italic">No upcoming compliance deadlines.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Overdue Milestones Alert Bar -->
{% if overdue_milestones %}
<div class="mt-8 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-r-lg" role="alert">
    <p class="font-bold">Overdue Contract Milestones</p>
    <ul class="list-disc list-inside mt-2">
        {% for contract in overdue_milestones %}
        <li>
            <a href="{% url 'contracts:contract_detail' contract.pk %}" class="hover:underline font-semibold">{{ contract.title }}</a> - was due on {{ contract.milestone_date }}
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% endblock %}

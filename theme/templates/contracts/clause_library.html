
{% extends "base.html" %}

{% block title %}Clause Library{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-primary-700">Clause Library</h1>
            <p class="text-muted mt-1">Manage reusable contract clauses</p>
        </div>
        <button class="btn-primary flex items-center space-x-2" onclick="openNewClauseModal()">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            <span>New Clause</span>
        </button>
    </div>

    <!-- Search and Filter Bar -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6">
        <div class="flex items-center space-x-4">
            <div class="flex-1">
                <input type="text" id="clause-search" placeholder="Search clauses by title or content..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
            </div>
            <select id="category-filter" class="px-3 py-2 border border-gray-300 rounded-md">
                <option value="">All Categories</option>
                <option value="liability">Liability</option>
                <option value="general">General</option>
                <option value="confidentiality">Confidentiality</option>
                <option value="termination">Termination</option>
                <option value="ip">Intellectual Property</option>
            </select>
            <div id="tag-filters" class="flex flex-wrap gap-2">
                <!-- Tag filters will be populated here -->
            </div>
        </div>
    </div>

    <!-- Clauses List -->
    <div class="bg-white rounded-lg border border-gray-200">
        <div class="divide-y divide-gray-200" id="clauses-list">
            <!-- Clauses will be loaded here -->
        </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="text-center py-12 hidden">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No clauses found</h3>
        <p class="mt-1 text-sm text-gray-500">Get started by creating your first clause.</p>
        <div class="mt-6">
            <button class="btn-primary" onclick="openNewClauseModal()">New Clause</button>
        </div>
    </div>
</div>

<!-- New Clause Modal -->
<div id="new-clause-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">Create New Clause</h3>
            <button onclick="closeNewClauseModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <form id="new-clause-form">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Clause Title</label>
                    <input type="text" name="title" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select name="category" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="general">General</option>
                        <option value="liability">Liability</option>
                        <option value="confidentiality">Confidentiality</option>
                        <option value="termination">Termination</option>
                        <option value="ip">Intellectual Property</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                    <textarea name="content" rows="8" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500"
                              placeholder="Enter the clause content..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tags (comma separated)</label>
                    <input type="text" name="tags" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500"
                           placeholder="liability, protection, legal">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeNewClauseModal()" class="btn-ghost">Cancel</button>
                <button type="submit" class="btn-primary">Create Clause</button>
            </div>
        </form>
    </div>
</div>

<script>
let clauses = [];
let availableTags = [];

document.addEventListener('DOMContentLoaded', function() {
    loadClauses();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('clause-search').addEventListener('input', debounce(filterClauses, 300));
    document.getElementById('category-filter').addEventListener('change', filterClauses);
    document.getElementById('new-clause-form').addEventListener('submit', handleNewClause);
}

function loadClauses() {
    clauses = [
        {
            id: 'cls-1',
            title: 'Limitation of Liability',
            category: 'liability',
            content: 'IN NO EVENT SHALL THE COMPANY BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL OR PUNITIVE DAMAGES...',
            tags: ['liability', 'protection', 'damages'],
            version: '1.0',
            created_at: '2024-01-15T10:00:00Z'
        },
        {
            id: 'cls-2',
            title: 'Force Majeure',
            category: 'general',
            content: 'Neither party shall be liable for any delay or failure to perform its obligations under this Agreement if such delay or failure results from circumstances beyond the reasonable control of such party...',
            tags: ['force-majeure', 'delays', 'performance'],
            version: '1.0',
            created_at: '2024-01-14T15:30:00Z'
        },
        {
            id: 'cls-3',
            title: 'Confidentiality',
            category: 'confidentiality',
            content: 'Each party acknowledges that it may receive confidential information of the other party. The receiving party agrees to maintain such information in confidence...',
            tags: ['confidentiality', 'nda', 'information'],
            version: '1.0',
            created_at: '2024-01-13T09:15:00Z'
        },
        {
            id: 'cls-4',
            title: 'Termination for Convenience',
            category: 'termination',
            content: 'Either party may terminate this Agreement at any time for any reason by providing thirty (30) days written notice to the other party...',
            tags: ['termination', 'cancellation', 'notice'],
            version: '1.0',
            created_at: '2024-01-12T14:20:00Z'
        }
    ];
    
    // Extract all unique tags
    availableTags = [...new Set(clauses.flatMap(clause => clause.tags))];
    
    renderClauses(clauses);
    renderTagFilters();
}

function renderClauses(clausesToRender) {
    const list = document.getElementById('clauses-list');
    const emptyState = document.getElementById('empty-state');
    
    if (clausesToRender.length === 0) {
        list.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
    }
    
    emptyState.classList.add('hidden');
    
    list.innerHTML = clausesToRender.map(clause => `
        <div class="p-6 hover:bg-gray-50">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <h3 class="text-lg font-medium text-gray-900">${clause.title}</h3>
                        <span class="inline-block bg-gray-100 px-2 py-1 rounded text-xs font-medium">${clause.category}</span>
                        <span class="text-xs text-gray-500">v${clause.version}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${clause.content.substring(0, 200)}...</p>
                    <div class="flex flex-wrap gap-1 mb-3">
                        ${clause.tags.map(tag => `<span class="inline-block bg-primary-100 text-primary-800 px-2 py-1 rounded text-xs">${tag}</span>`).join('')}
                    </div>
                </div>
                <div class="flex items-center space-x-2 ml-4">
                    <button onclick="insertClause('${clause.id}')" class="btn-outline btn-sm">Insert</button>
                    <button onclick="editClause('${clause.id}')" class="text-gray-400 hover:text-primary-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </button>
                    <button onclick="deleteClause('${clause.id}')" class="text-gray-400 hover:text-red-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function renderTagFilters() {
    const container = document.getElementById('tag-filters');
    container.innerHTML = availableTags.map(tag => `
        <button onclick="toggleTagFilter('${tag}')" 
                class="tag-filter px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-primary-50 hover:border-primary-300"
                data-tag="${tag}">
            ${tag}
        </button>
    `).join('');
}

function filterClauses() {
    const searchTerm = document.getElementById('clause-search').value.toLowerCase();
    const categoryFilter = document.getElementById('category-filter').value;
    const selectedTags = Array.from(document.querySelectorAll('.tag-filter.active')).map(btn => btn.dataset.tag);
    
    let filtered = clauses.filter(clause => {
        const matchesSearch = clause.title.toLowerCase().includes(searchTerm) || 
                            clause.content.toLowerCase().includes(searchTerm) ||
                            clause.tags.some(tag => tag.toLowerCase().includes(searchTerm));
        
        const matchesCategory = !categoryFilter || clause.category === categoryFilter;
        
        const matchesTags = selectedTags.length === 0 || 
                          selectedTags.some(tag => clause.tags.includes(tag));
        
        return matchesSearch && matchesCategory && matchesTags;
    });
    
    renderClauses(filtered);
}

function toggleTagFilter(tag) {
    const button = document.querySelector(`[data-tag="${tag}"]`);
    button.classList.toggle('active');
    button.classList.toggle('bg-primary-100');
    button.classList.toggle('border-primary-300');
    button.classList.toggle('text-primary-800');
    filterClauses();
}

function openNewClauseModal() {
    document.getElementById('new-clause-modal').classList.remove('hidden');
    document.querySelector('input[name="title"]').focus();
}

function closeNewClauseModal() {
    document.getElementById('new-clause-modal').classList.add('hidden');
    document.getElementById('new-clause-form').reset();
}

function handleNewClause(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    const newClause = {
        id: `cls-${Date.now()}`,
        title: formData.get('title'),
        category: formData.get('category'),
        content: formData.get('content'),
        tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag),
        version: '1.0',
        created_at: new Date().toISOString()
    };
    
    clauses.unshift(newClause);
    availableTags = [...new Set([...availableTags, ...newClause.tags])];
    
    renderClauses(clauses);
    renderTagFilters();
    closeNewClauseModal();
    
    showToast('Clause created successfully!', 'success');
}

function insertClause(clauseId) {
    const clause = clauses.find(c => c.id === clauseId);
    if (clause) {
        // In real app, this would insert the clause into the active contract/template editor
        showToast(`Inserted "${clause.title}" clause`, 'success');
        
        // Mock copying to clipboard
        navigator.clipboard.writeText(clause.content).then(() => {
            showToast('Clause copied to clipboard', 'info');
        });
    }
}

function editClause(clauseId) {
    showToast('Clause editing coming soon!', 'info');
}

function deleteClause(clauseId) {
    if (confirm('Are you sure you want to delete this clause?')) {
        clauses = clauses.filter(c => c.id !== clauseId);
        renderClauses(clauses);
        showToast('Clause deleted successfully!', 'success');
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'n' && !e.target.matches('input, textarea')) {
        e.preventDefault();
        openNewClauseModal();
    }
    if (e.key === 'Escape') {
        closeNewClauseModal();
    }
    if (e.key === '/' && !e.target.matches('input, textarea')) {
        e.preventDefault();
        document.getElementById('clause-search').focus();
    }
});
</script>
{% endblock %}
